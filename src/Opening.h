/*
 * Copyright (c) 2024 Viorel Darie. All rights reserved.
 *
 * Permission to use, copy, modify, and/or distribute this software
 * for any purpose is hereby granted, under the terms of the MIT license.
 *
 * If a copy of the license was not distributed with this file, it can
 * be obtained from https://opensource.org/licenses/MIT/.
 */

struct OpeningText OpeningText[] = { "1  e2-e4",
                                     "1a e7-e5",
                                     "2  g1-f3",
                                     "2a b8-c6",
                                     "3  f1-b5 Partida Spaniola ",
                                     "3a a7-a6",
                                     "4  b5-c4",
                                     "4a g8-f6",
                                     "5  e1-g1",
                                     "5a f8-e7",
                                     "6  f1-e1",
                                     "6a b7-b5",
                                     "7  c4-b3",
                                     "7a d7-d6",
                                     "8  c2-c3",
                                     "8a e8-g8",
                                     "9  h2-h3",
                                     "9a h7-h6",
                                     "10 d2-d4",
                                     "10a f8-e8  Varianta Smaslov ",

                                     "6  d2-d4",
                                     "6a e5xd4",
                                     "7  f3-d4",

                                     "5  d2-d3",
                                     "5a d7-d6",
                                     "6  c2-c3",
                                     "6a f8-e7",

                                     "1  e2-e4",
                                     "1a e7-e5",
                                     "2  g1-f3",
                                     "2a g8-f6",

                                     "3  f3-e5  Partida Rusa",
                                     "3a d7-d6",
                                     "4  e5-f3",
                                     "4a f6-e4",
                                     "5  d2-d4",
                                     "5a f8-e7",

                                     "2  g1-f3",
                                     "2a b8-c6",
                                     "3  b1-c3",
                                     "3a g8-f6 Jocul celor patru cai ",

                                     "3  d2-d4",
                                     "3a e5-d4 Partida scotiana ",

                                     "3  f1-c4 Partida italiana ",

                                     "3a f8-c5 Giuoco Piano ",

                                     "4  b2-b4 Gambitul Evans ",
                                     "4a c5xb4",
                                     "5  c2-c3",
                                     "5a b4-a5",
                                     "6  d2-d4",
                                     "6a e5xd4",
                                     "7  e1-g1",
                                     "7a d4xc3",
                                     "8  d1-b3",
                                     "8a d8-e7",

                                     "3a g8-f6 Jocul celor doi cai ",

                                     "3a f8-e7 Apararea ungara ",

                                     "3  f1-e2 Deschiderea ungara inversata ",

                                     "3a g8-f6 Jocul celor patru cai",

                                     "2  g1-f3",
                                     "2a g8-f6 Apararea Petrov ",

                                     "2a d7-d5 Gambitul elefantului ",

                                     "2a d7-d6 Apararea Philidor ",

                                     "2a f7-f5 Gambitul leton ",

                                     "2a f7-f6 Apararea Damiano ",

                                     "2a d8-f6 Apararea Greco ",

                                     "2 d2-d4",
                                     "2a e5xd4 Gambitul central ",

                                     "3 c2-c3 Gambitul danez ",

                                     "2 f2-f4 Gambitul regelui ",

                                     "2a g8-f6",
                                     "3 f4xe5",
                                     "3a f6-e4",
                                     "4 g1-f3",
                                     "4a e4-g5",
                                     "5 d2-d4",
                                     "5a g5xf3",
                                     "6 d1xf3",
                                     "6a d8-h4",

                                     "2a e5-f4",
                                     "3  f1-c4",
                                     "3a d8-h4",
                                     "4  e1-f1",
                                     "4a d7-d6",

                                     "3a g8-f6",
                                     "4  b1-c3",
                                     "4a f8-b4",
                                     "5  e4-e5",
                                     "5a d7-d5",

                                     "2 f1-c4 Deschiderea nebunului ",

                                     "2 b1-c3 Jocul vienez ",

                                     "2 f1-b5 Deschiderea portugheza ",

                                     "2 c2-c3 Deschiderea Lopez ",

                                     "2 g1-e2 Deschiderea Alapin ",

                                     "2 g1-f3 Deschiderea Napoleon ",

                                     "1a c7-c5 Apararea siciliana ",
                                     "2  g1-f3",
                                     "2a d7-d6",
                                     "3  d2-d4",
                                     "3a c5-d4",
                                     "4  f3-d4",
                                     "4a g8-f6",
                                     "5  b1-c3",
                                     "5a a7-a6",

                                     "2a b8-c6",
                                     "3  d2-d4",
                                     "3a c5-d4",
                                     "4  f3-d4",
                                     "4a e7-e6",
                                     "5  b1-c3",
                                     "5a d8-c7",
                                     "6  g2-g3",

                                     "1a c7-c6 Apararea Caro-Kann ",
                                     "2  d2-d4",
                                     "2a d7-d5",
                                     "3  e4xd5",
                                     "3a c6xd5",
                                     "4  f1-d3",
                                     "4a b8-c6",
                                     "5  c2-c3",
                                     "5a g8-f6",

                                     "1a d7-d5 Apararea scandinava ",

                                     "1a e7-e6 Apararea franceza ",
                                     "2  d2-d3",
                                     "2a d7-d5",
                                     "3  b1-d2",
                                     "3a g8-f6",
                                     "4  g1-f3",
                                     "4a c7-c5",
                                     "5  g2-g3",
                                     "5a b8-c6",
                                     "6  f1-g2",
                                     "6a f8-e7",
                                     "7  e1-g1",
                                     "7a e8-g8",
                                     "8  f1-e1",
                                     "8a b7-b5",

                                     "1a b8-c6 Apararea Nimzovici ",

                                     "1a g8-f6 Apararea Alehin ",

                                     "1a g7-g6 Apararea Iugoslava",
                                     "2  d2-d4",
                                     "2a f8-g7",
                                     "3  b1-c3",
                                     "3a d7-d6",
                                     "4  f2-f4",
                                     "4a g8-f6",
                                     "5  g1-f3",
                                     "5a e8-g8",

                                     "1  d2-d4",
                                     "1a d7-d5",
                                     "2  c2-c4 Gambitul damei ",
                                     "2a e7-e6",
                                     "3  b1-c3",
                                     "3a f8-e7",
                                     "4  g1-f3",
                                     "4a g8-f6",
                                     "5  c1-g5",
                                     "5a e8-g8",
                                     "6  e2-e3",
                                     "6a h7-h6",
                                     "7  g5-h4",
                                     "7a b7-b6",
                                     "8  c4xd5",
                                     "8a f6-d5",
                                     "9  h4-e7",

                                     "2a d5xc4 Gambitul damei acceptat ",

                                     "2a e7-e6 Gambitul damei refuzat ",

                                     "2a c7-c5 Apararea simetrica ",

                                     "2a c7-c6 Apararea slava ",

                                     "2a e7-e5 Contra gambitul Albin ",

                                     "2a b8-c6 Apararea Chigorin ",

                                     "2a c8-f5 Apararea baltica ",

                                     "2a g8-f6 Apararea Marshall ",

                                     "2  e2-e3 Atacul Stonewall ",

                                     "2  e2-e4 Gambitul Blackmar-Diemer ",

                                     "2  g1-f3",
                                     "2a g8-f6",
                                     "3  e2-e3 Partida pionului damei ",

                                     "2a g8-f6",
                                     "3  c1-g5 Atacul Richter-Veresov ",

                                     "1a d7-d5",
                                     "2  c2-c4 Gambitul damei pentru alb",
                                     "2a e7-e6",
                                     "3  b1-c3",
                                     "3a f8-e7",
                                     "4  g1-f3",
                                     "4a g8-f6",
                                     "5  c1-g5",
                                     "5a e8-g8",

                                     "1a g8-f6 Sisteme indiene (1.d4 Cf6)",

                                     "2  c2-c4",
                                     "2a e7-e5 Gambitul Budapesta ",

                                     "2  c2-c4",
                                     "2a e7-e6",
                                     "3  g2-g3 Deschiderea catalana ",

                                     "3  b1-c3",
                                     "3a f8-b4 Indiana Nimzovici ",

                                     "3a b7-b5 Apararea poloneza ",

                                     "3a c7-c5",
                                     "4  d4-d5",
                                     "4a b7-b5 Gambitul Blumenfeld ",

                                     "3  g1-f3",
                                     "3a f6-e4 Apararea D�ry ",

                                     "3a b7-b6 Indiana damei ",

                                     "2a g7-g6",
                                     "3 b1-c3",
                                     "3a f8-g7 Indiana regelui ",
                                     "4  e2-e4",
                                     "4a d7-d6",
                                     "5  f2-f3",
                                     "5a c7-c5 Fischer ",

                                     "3a d7-d5 Apararea Gr�nfeld ",

                                     "2a b8-c6 Tangoul cailor negri ",

                                     "2  g1-f3",
                                     "2a e7-e6",
                                     "3  c1-g5 Atacul Torre ",

                                     "1a g8-f6",
                                     "2  c1-g5 Atacul Trompowski ",

                                     "1a b7-b5 Apararea poloneza ",

                                     "1a b7-b6 Apararea engleza ",

                                     "1a c7-c5 Apararea Benoni ",

                                     "1a d7-d6 Apararea Wade ",

                                     "1a e7-e5 Gambitul Englund ",

                                     "1a f7-f5 Apararea olandeza ",

                                     "1  c2-c4",
                                     "1a e7-e5 Partida engleza ",
                                     "1a g8-f6",
                                     "2  b1-c3",
                                     "2a e7-e6",
                                     "3  g1-f3",
                                     "3a f8-b4",

                                     "1a g7-g6  Apararea Grunfield",
                                     "2  d2-d4",
                                     "2a g8-f6",
                                     "3  b1-c3",
                                     "3a d7-d5",

                                     "1  g1-f3",
                                     "1a d7-d5 Deschiderea R�ti ",

                                     "xx" };

int
ProcessOpeningFile ()
{
  int i;
  char cmove[80];
  char nb[4];
  char tmove[20];
  char comment[80];
  int n;
  int aa;
  int nbOpen;
  int MoveToDo;

  int lin, col, sq1, sq2;

  int err;

  char ch;

  if ((tabla[25] != 6) || (tabla[95] != 12))
    return 1;

  // return 1;
  // 1. Process primary text file
  nbOpeningMoves = 0;
  for (i = 0;; i++)
    {
      strcpy (cmove, OpeningText[i].cmove);
      // isolate a word
      if (cmove[0] == 'x')
        break; // no more opening moves
      k = 0;
      TakeWord (nb, cmove, 0);
      TakeWord (tmove, cmove, 0);
      TakeWord (comment, cmove, 1);
      // convert words to OpeningMove.move

      // convert move number max 2 digits
      n = 0;

      err = 0;
      if ((nb[0] < '0') || (nb[0] > '9'))
        err++;

      if ((nb[0] >= '0') && (nb[0] <= '9'))
        n = (nb[0] - 48) * 2;

      if ((nb[1] != 'a') && (nb[1] > 0))
        {
          if ((nb[1] < '0') || (nb[1] > '9'))
            err++;

          if ((nb[1] >= '0') && (nb[1] <= '9'))
            n = n * 10 + (nb[1] - 48) * 2;
          if (nb[2] == 'a')
            n++; // black  move
        }
      if (nb[1] == 'a')
        n = n + 1;

      OpeningBinary[i].moveNumber = n - 2; // first move is index zero

      // Convert move to bynary move
      //
      // test for errors
      ch = tmove[0];
      if ((ch >= 'a') && (ch < 'z'))
        ch = ch - 32; // convert to lowercase

      if ((ch < 'A') && (ch > 'H'))
        err++;

      col = ch - 'A' + 1;

      ch = tmove[1];
      if ((ch < '1') && (ch > '8'))
        err++;

      lin = ch - '0' + 1;

      sq1 = lin * 10 + col;

      ch = tmove[2];
      if ((ch != '-') && (ch != 'x'))
        err++; // convert to lowercase

      ch = tmove[3];
      if ((ch >= 'a') && (ch < 'z'))
        ch = ch - 32; // convert to lowercase

      if ((ch < 'A') && (ch > 'H'))
        err++;

      col = ch - 'A' + 1;

      ch = tmove[4];
      if ((ch < '1') && (ch > '8'))
        err++;

      lin = ch - '0' + 1;

      sq2 = lin * 10 + col;
      int xx = sq1 * 256 + sq2;
      OpeningBinary[i].OpeningMove = (sq1 << 8) + sq2;
      strcpy (OpeningBinary[i].comment, comment);
      nbOpeningMoves++;

      // test if there was an error on line

      if (err > 0)
        MessageBox (hWnd, cmove, " EROARE IN DESCRIEREA DESCHIDERI", MB_OK);

    } // end for

  // 2. Map the moves to actual move from game

  InitGame ();

  gameDepth = 0;
  treeDepth = 0;
  for (nbOpen = 0; nbOpen < nbOpeningMoves; nbOpen++)
    {
      if (OpeningBinary[nbOpen].moveNumber < gameDepth)
        {
          for (;;)
            {
              MoveBack ();
              if (OpeningBinary[nbOpen].moveNumber == gameDepth)
                break;
            }
        };

      kmax = 2;
      MoveToDo = OpeningBinary[nbOpen].OpeningMove;

      int SqFrom = (MoveToDo >> 8) & 255;
      int SqTo = (MoveToDo & 255);
      if (SqFrom == 25 && SqTo == 27)
        MoveToDo += (1 << 24);
      if (SqFrom == 95 && SqTo == 97)
        MoveToDo += (2 << 24);

      SetStruct ();
      if (SqFrom == 25 && SqTo == 26)
        {
          who = who;
        }
      GenLevelMoves (0);
      if (SqFrom == 25 && SqTo == 23)
        MoveToDo += (1 << 24);
      if (SqFrom == 95 && SqTo == 93)
        MoveToDo += (2 << 24);

      aa = AllowedMove (MoveToDo, MoveToDo);

      if (aa == 0)
        {
          MessageBox (hWnd, " Exista o mutare imposibila !!!!!!!",
                      " EROARE FISIER DESCHIDERE ", MB_OK);
        }
      else
        {
          OpeningBinary[nbOpen].OpeningMove = MoveToDo;
        }

      PlayMove (MoveToDo);
    };
  for (; gameDepth > treeDepth;)
    {
      MoveBack (); // this decrement gameDepth
      SetStruct ();
    }

  InitGame ();

  return 1;
}

//
// Take Opening Move
//
int
TakeOpeningMove ()
{
  int i;
  char cmove[80];
  findopening = 0;
  int aa;
  char comment[80];

  int ind;
  int randmove;
  int MoveToDo;

  int* pmSave;
  time_t tim;

  int nbOpen;

  int gDepth;

  int OpeningCandidates[100]; // here store all moves possible to continuing
                              // opening
  int StackTa[100]; // found candidates to opening reply

  char SaveMessages[100][60];

  int nbOpenings;

  // return 0;

  strcpy (openingMessage, "");

  if (gameDepth > 50)
    return 0; // no longer openings than 25 full plyes

  pmSave = pm;
  nbOpenings = 0;
  gDepth = 0;
  for (i = 0; i < 120; i++)
    ta[i] = tabla0[i];
  // 1. Select all possible moves from opening file posible from current
  // chessboard position

  for (nbOpen = 0; nbOpen < nbOpeningMoves; nbOpen++)
    {
      if (gDepth > OpeningBinary[nbOpen].moveNumber)
        {
          for (;;)
            {
              gDepth--;
              MoveToDoTa = StackTa[gDepth];
              MoveBackTa ();
              who = (who + 1) & 1;
              if (gDepth == OpeningBinary[nbOpen].moveNumber)
                break;
            }
        };
      MoveToDoTa = OpeningBinary[nbOpen].OpeningMove;

      // if Ta[] == Tabla[] then note this MoveToDo
      ind = 1;
      for (i = 0; i < 120; i++)
        {
          if (ta[i] != tabla[i])
            ind = 0;
        }

      if (ind == 1)
        {
          // found - then save succesor
          OpeningCandidates[nbOpenings] = OpeningBinary[nbOpen].OpeningMove;
          //			CopyMove(&OpeningBinary[nbOpen].OpeningMove,&OpeningCandidates[nbOpenings]);
          strcpy (SaveMessages[nbOpenings], OpeningBinary[nbOpen].comment);
          nbOpenings++;
        }
      StackTa[gDepth] = MoveToDoTa;
      //		CopyMove(&MoveToDoTa,&StackTa[gDepth]);
      PlayMoveTa ();
      who = (who + 1) & 1;

      gDepth++;

    }; // end for

  // 2. Select the candidate to continue opening

  if (nbOpenings == 0)
    {
      pm = pmSave;
      return 0; // no opening this time
    }

  time (&tim);
  randmove = 0;
  if (nbOpenings > 1)

    randmove = tim % (nbOpenings);

  MoveToDo = OpeningCandidates[randmove];
  //	  CopyMove(&OpeningCandidates[randmove], &MoveToDo);
  strcpy (openingMessage, SaveMessages[randmove]);

  // 3. Finally, verify is the the opening move exists on current table
  kmax = 2;

  SetStruct ();

  GenLevelMoves (0); // generate the possible moves from current chessboard

  aa = AllowedMove (MoveToDo, MoveToDo);
  if (aa == 0)
    {
      MessageBox (hWnd, " Deschidere o mutare imposibila !!!!!!!",
                  " EROARE FISIER DESCHIDERE ", MB_OK);
    }
  else
    {
      OptimalMove = MoveToDo;
      //		CopyMove(&MoveToDo,&OptimalMove);
      //		CopyMove(&MoveToDo,&Stack2[gameDepth].explicitMove);
      //		CopyMove(&MoveToDo,&Stack[gameDepth].BestWay[0]);
      //		CopyMove(&MoveToDo,&Stack[gameDepth].bestmove);
      Stack2[gameDepth].BestWay[1] = 0;
      findopening = 1;
    }
  pm = pmSave;
  treeDepth = gameDepth;
  return 1;
}

// Extract a word from a text line
int
TakeWord (char text[], char cmove[], int mode)
{
  int j;
  j = 0;
  char ch;

  if (mode == 0)
    ch = ' ';
  else
    ch = '\0';

  text[j] = '\0';

  for (;; k)
    {
      // find first no blank character
      if ((cmove[k] != ' ') || (cmove[k] == '\0'))
        break;
      k++;
    }
  for (;; k)
    {
      // find first blank character, and non blank put on the extracted word
      if ((cmove[k] == ch) || (cmove[k] == '\0'))
        break;
      text[j] = cmove[k];
      k++;
      j++;
    }
  text[j] = '\0';

  return 1;
}
